---
- name: Test Deploy update.sh sur Batch1 (10 serveurs) - Version sans pkill
  hosts: batch1
  gather_facts: no
  tasks:
    - name: "1ï¸âƒ£ VÃ©rifier l'existence du script update.sh"
      raw: |
        if [ -f /mnt/www/update.sh ]; then
          echo "âœ… Script /mnt/www/update.sh trouvÃ©"
          ls -la /mnt/www/update.sh
        else
          echo "âŒ Script /mnt/www/update.sh introuvable"
          ls -la /mnt/www/ 2>/dev/null || echo "RÃ©pertoire /mnt/www/ inexistant"
        fi
      register: script_check
      
    - name: "ğŸ“‹ Afficher le statut du script"
      debug:
        msg: "{{ script_check.stdout_lines }}"
        
    - name: "2ï¸âƒ£ VÃ©rifier les processus update.sh existants"
      raw: |
        echo "ğŸ” Processus update.sh actuellement actifs:"
        ps aux | grep update.sh | grep -v grep || echo "Aucun processus update.sh actif"
      register: process_check
      
    - name: "ğŸ“Š Ã‰tat des processus"
      debug:
        msg: "{{ process_check.stdout_lines }}"
        
    - name: "3ï¸âƒ£ Lancer le script update.sh avec monitoring"
      raw: |
        if [ -f /mnt/www/update.sh ]; then
          LOG_FILE="/mnt/www/log/update-jenkins-batch1-$(date +%Y%m%d-%H%M%S).log"
          echo "ğŸš€ Lancement du script update.sh sur $(hostname)..."
          echo "ğŸ“‹ Log: $LOG_FILE"
          
          # CrÃ©er le rÃ©pertoire log s'il n'existe pas
          mkdir -p /mnt/www/log
          
          chmod +x /mnt/www/update.sh
          cd /mnt/www
          nohup ./update.sh > "$LOG_FILE" 2>&1 &
          NEW_PID=$!
          echo "âœ… Script lancÃ© sur $(hostname), PID: $NEW_PID"
          
          echo "â³ Attente 5 secondes pour vÃ©rifier le dÃ©marrage..."
          sleep 5
          
          if ps -p $NEW_PID > /dev/null 2>&1; then
            echo "âœ… Processus $NEW_PID toujours actif - Script en cours sur $(hostname)"
            echo "ğŸ“„ PremiÃ¨res lignes du log:"
            head -3 "$LOG_FILE" 2>/dev/null || echo "Log en cours de crÃ©ation..."
          else
            echo "âŒ Processus $NEW_PID terminÃ© - VÃ©rification des logs:"
            cat "$LOG_FILE" 2>/dev/null || echo "Aucun log gÃ©nÃ©rÃ©"
          fi
          
          echo "ğŸ“ Log complet disponible: $LOG_FILE"
        else
          echo "âš ï¸ Impossible de lancer : script introuvable"
        fi
      register: deploy_result
      
    - name: "ğŸ“Š RÃ©sultat final du dÃ©ploiement"
      debug:
        msg: "{{ deploy_result.stdout_lines }}"
