---
- name: ğŸš€ DÃ©ploiement update.sh sur tous les groupes Linkuma
  hosts: all_linkuma
  gather_facts: no
  serial: 10  # Traiter 10 serveurs en parallÃ¨le max
  tasks:
    - name: VÃ©rifier la connexion SSH
      raw: echo "âœ… Connexion OK - $(hostname) - $(date)"
      register: connection_test
      
    - name: Afficher statut connexion
      debug:
        msg: "{{ connection_test.stdout }}"
    
    - name: CrÃ©er le rÃ©pertoire /mnt/www s'il n'existe pas
      raw: mkdir -p /mnt/www
      
    - name: CrÃ©er le rÃ©pertoire de logs
      raw: mkdir -p /mnt/www/log
      
    - name: VÃ©rifier la prÃ©sence d'update.sh existant
      raw: ls -la /mnt/www/update.sh 2>/dev/null || echo "Fichier absent"
      register: current_script
      
    - name: Afficher l'Ã©tat du script existant
      debug:
        msg: "{{ current_script.stdout }}"
    
    - name: Copier le script update.sh depuis group57 (serveur de rÃ©fÃ©rence)
      raw: |
        echo "ğŸ“‚ RÃ©cupÃ©ration du script depuis group57..."
        scp -o "ProxyJump=bastion@infra.linkuma.ovh:2200" \
            -o "StrictHostKeyChecking=no" \
            -P 2222 \
            root@apache.group57.svc.cluster.local:/mnt/www/update.sh \
            /tmp/update.sh.new 2>/dev/null || {
            echo "âŒ Erreur rÃ©cupÃ©ration depuis group57"
            exit 1
        }
        
        # Sauvegarder l'ancien script s'il existe
        if [ -f /mnt/www/update.sh ]; then
            cp /mnt/www/update.sh /mnt/www/update.sh.backup.$(date +%Y%m%d-%H%M%S)
            echo "ğŸ’¾ Script existant sauvegardÃ©"
        fi
        
        # Installer le nouveau script
        mv /tmp/update.sh.new /mnt/www/update.sh
        chmod +x /mnt/www/update.sh
        
        # VÃ©rifier la syntaxe
        bash -n /mnt/www/update.sh && echo "âœ… Syntaxe OK" || echo "âŒ Erreur syntaxe"
        
        echo "ğŸ‰ Script update.sh dÃ©ployÃ© avec succÃ¨s sur $(hostname)"
      register: deployment_result
      
    - name: Afficher le rÃ©sultat du dÃ©ploiement
      debug:
        msg: "{{ deployment_result.stdout_lines }}"
        
    - name: Test rapide du script (dry-run)
      raw: |
        echo "ğŸ§ª Test rapide du script..."
        cd /mnt/www
        # Test des premiers sites seulement
        timeout 30 bash -c '
            sites_count=$(find /mnt/www -maxdepth 2 -name "wp-config.php" 2>/dev/null | wc -l)
            echo "Sites WordPress dÃ©tectÃ©s: $sites_count"
            
            if command -v wp >/dev/null 2>&1; then
                echo "âœ… WP-CLI disponible"
            else
                echo "âŒ WP-CLI manquant"
            fi
        ' || echo "âš ï¸ Test interrompu aprÃ¨s 30s"
      register: test_result
      
    - name: Afficher le rÃ©sultat du test
      debug:
        msg: "{{ test_result.stdout_lines }}"

    - name: RÃ©sumÃ© du dÃ©ploiement
      debug:
        msg: |
          ğŸ¯ DÃ©ploiement terminÃ© sur {{ inventory_hostname }}
          ğŸ“Š Script update.sh installÃ© et testÃ©
          ğŸ“ Logs disponibles dans /mnt/www/log/
          ğŸš€ PrÃªt pour exÃ©cution via Jenkins
